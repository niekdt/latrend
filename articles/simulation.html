<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conducting a simulation study â€¢ latrend</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Conducting a simulation study">
<meta property="og:description" content="latrend">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">latrend</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/demo.html">Demonstration of latrend package</a>
    </li>
    <li>
      <a href="../articles/implement.html">Implementing new models</a>
    </li>
    <li>
      <a href="../articles/simulation.html">Conducting a simulation study</a>
    </li>
    <li>
      <a href="../articles/validation.html">Validating cluster models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/philips-software/latrend/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="simulation_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Conducting a simulation study</h1>
                        <h4 data-toc-skip class="author">Niek Den Teuling</h4>
            
            <h4 data-toc-skip class="date">2021-09-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/philips-software/latrend/blob/HEAD/vignettes/simulation.Rmd" class="external-link"><code>vignettes/simulation.Rmd</code></a></small>
      <div class="hidden name"><code>simulation.Rmd</code></div>

    </div>

    
    
<div class="section level1">
<h1 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h1>
<p>In this vignette we demonstrate how to conduct a simulation study with minimal coding. We show how to do a structural evaluation of methods for clustering longitudinal data, for different specifications, and across various (synthetic) data scenarios.</p>
<p>A typical workflow in a simulation study involves:</p>
<ol style="list-style-type: decimal">
<li><a href="#data-settings">Data settings</a></li>
<li><a href="#method-settings">Method settings</a></li>
<li><a href="#evaluating-the-settings">Evaluating the settings</a></li>
<li><a href="#analyzing-the-results">Analyzing the results</a></li>
</ol>
<p>There are many packages available in <code>R</code> which facilitate such a workflow. In this vignette, we use the <a href="https://cran.r-project.org/package=simTool" class="external-link">simTool</a> package.</p>
<p>Due to the relatively large number of models fitted, we will disable all model outputs:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/philips-software/latrend" class="external-link">latrend</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>latrend.verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level1">
<h1 id="data-generation">Data generation<a class="anchor" aria-label="anchor" href="#data-generation"></a>
</h1>
<p>Using synthetic data allows us to investigate to performance of the methods under specific conditions of interest (e.g., sensitivity to noise, within-cluster variability, and cluster separation).</p>
<p>For demonstration purposes, we define a trivial dataset comprising two distinct groups with group trajectories represented by a line (i.e., intercept and slope). A trajectory <span class="math inline">\(\textbf{y}_i\)</span> belonging to group <span class="math inline">\(k\)</span> is described by <span class="math inline">\(y_{ij} = \beta_{0k} + \beta_{1k} t_{j} + z_{0i} + e_{ij}\)</span>. Here, <span class="math inline">\(\beta_{0k}\)</span> and <span class="math inline">\(\beta_{1k}\)</span> are the intercept and slope for group <span class="math inline">\(k\)</span>, respectively. Furthermore, <span class="math inline">\(z_i\)</span> denotes the trajectory-specific random intercept, i.e., its deviation from the group trajectory. Lastly, <span class="math inline">\(e_{ij}\)</span> represents independent random noise with <span class="math inline">\(e_{ij} \sim N(0, \sigma^2)\)</span>.</p>
<p>We can generate data according to this model using a utility function named <code><a href="../reference/generateLongData.html">generateLongData()</a></code> that is included in the package. This function generates datasets based on a mixture of linear mixed models. We create a wrapper around this function in order to adapt the function to our needs. Most importantly, we code the shape and coefficients of the group trajectories as fixed, setting <span class="math inline">\((\beta_{0A},\beta_{1A}) = (0, 0)\)</span> for group A (40%) and <span class="math inline">\((\beta_{0B},\beta_{1B}) = (1, -1)\)</span> for group B (60%). Other data settings (e.g., the magnitude of perturbation) are passed via <code>...</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataGen</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">numTraj</span>, <span class="va">...</span>, <span class="va">data.seed</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">latrend</span><span class="fu">::</span><span class="fu"><a href="../reference/generateLongData.html">generateLongData</a></span><span class="op">(</span>
    sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">numTraj</span> <span class="op">*</span> <span class="fl">.4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">numTraj</span> <span class="op">*</span> <span class="fl">.6</span><span class="op">)</span><span class="op">)</span>,
    fixed <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">Time</span>,
    cluster <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">Time</span>,
    random <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>,
    id <span class="op">=</span> <span class="st">"Traj"</span>,
    clusterCoefs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
    seed <span class="op">=</span> <span class="va">data.seed</span>,
    <span class="va">...</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Because the <em>simTool</em> package does not appear to support overlapping names between data and method functions, we needed to rename the <code>seed</code> argument of our underlying data generating function.</p>
<p>Note that the <code>generateLongData</code> is included in the <em>latrend</em> package primarily for demonstration purposes. For generating data in a more flexible way, consider using the <a href="https://cran.r-project.org/package=simstudy" class="external-link">simstudy</a> package.</p>
<p>Now that we have defined a data generating function, we set the default trajectory id and time column names, so we do not have to specify this in any future calls.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>latrend.id <span class="op">=</span> <span class="st">"Traj"</span>, latrend.time <span class="op">=</span> <span class="st">"Time"</span><span class="op">)</span></code></pre></div>
<p>Itâ€™s a good idea to inspect the data we are generating.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">exampleData</span> <span class="op">&lt;-</span> <span class="fu">dataGen</span><span class="op">(</span>numTraj <span class="op">=</span> <span class="fl">200</span>, randomScale <span class="op">=</span> <span class="fl">.1</span>, data.seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="../reference/plotTrajectories.html">plotTrajectories</a></span><span class="op">(</span><span class="va">exampleData</span>, response <span class="op">=</span> <span class="st">"Y"</span><span class="op">)</span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
</div>
<div class="section level1">
<h1 id="data-settings">Data settings<a class="anchor" aria-label="anchor" href="#data-settings"></a>
</h1>
<p>We now specify the data settings of interest. In this example, we evaluate the methods on datasets with varying sample size (50 and 250 trajectories) and random intercept scale (small and large random intercept). Moreover, we evaluate methods repeatedly under these settings by specifying different values for <code>data.seed</code>, generating a slightly different dataset for each seed.</p>
<p>As we intend to evaluate the methods on each combination of data settings, we need to generate a table of all permutations. This can be done using the <code><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid()</a></code> function, or using <code>expand_tibble()</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataGrid</span> <span class="op">&lt;-</span> <span class="fu">simTool</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/simTool/man/expand_tibble.html" class="external-link">expand_tibble</a></span><span class="op">(</span>
  fun <span class="op">=</span> <span class="st">"dataGen"</span>,
  numTraj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">250</span><span class="op">)</span>,
  randomScales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">.5</span><span class="op">)</span>,
  data.seed <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dataGrid</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 Ã— 4</span></span>
<span class="co">#&gt;   fun     numTraj randomScales data.seed</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> dataGen      50          0.1         1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> dataGen     250          0.1         1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> dataGen      50          0.5         1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> dataGen     250          0.5         1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> dataGen      50          0.1         2</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">6</span> dataGen     250          0.1         2</span></code></pre></div>
</div>
<div class="section level1">
<h1 id="method-settings">Method settings<a class="anchor" aria-label="anchor" href="#method-settings"></a>
</h1>
<p>Similarly to the data settings table, we specify a table of all permutations for the method settings. Typically this is done separately for each method, as their settings will usually differ. In this example we evaluate KmL and GCKM only on differing number of clusters so the method settings can be jointly generated. Repeated method evaluation is achieved through specifying several values for the <code>seed</code> argument.</p>
<p>The method evaluation function (specified by the <code>proc</code> field) here is simply the <code><a href="../reference/latrend.html">latrend()</a></code> function, which will fit the specified method type to the generated data. ## Specfying the KmL method</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">kmlMethodGrid</span> <span class="op">&lt;-</span> <span class="fu">simTool</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/simTool/man/expand_tibble.html" class="external-link">expand_tibble</a></span><span class="op">(</span>
  proc <span class="op">=</span> <span class="st">"latrend"</span>,
  method <span class="op">=</span> <span class="st">"lcMethodKML"</span>,
  nClusters <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,
  seed <span class="op">=</span> <span class="fl">1</span>,
  response <span class="op">=</span> <span class="st">"Y"</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">kmlMethodGrid</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 Ã— 5</span></span>
<span class="co">#&gt;   proc    method      nClusters  seed response</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> latrend lcMethodKML         1     1 Y       </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> latrend lcMethodKML         2     1 Y       </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> latrend lcMethodKML         3     1 Y</span></code></pre></div>
<div class="section level2">
<h2 id="specifying-the-gckm-method">Specifying the GCKM method<a class="anchor" aria-label="anchor" href="#specifying-the-gckm-method"></a>
</h2>
<p>Parametric models such as GCKM are more unwieldy to specify in a simulation study due to the need to define the parametric shape through one or more formulas. Formulas are tedious to query or filter in a post-hoc simulation analysis<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</p>
<p>We can solve this by defining simple keywords representing the different parametric shapes of interest. We then specify a wrapper function for <code><a href="../reference/latrend.html">latrend()</a></code> that sets the correct <code>formula</code> argument depending on the keyword.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fitGCKM</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">type</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">form</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">type</span>,
    constant <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">Time</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">Traj</span><span class="op">)</span>,
    linear <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">Time</span> <span class="op">+</span> <span class="op">(</span><span class="va">Time</span> <span class="op">|</span> <span class="va">Traj</span><span class="op">)</span>
  <span class="op">)</span>
  
  <span class="fu"><a href="../reference/latrend.html">latrend</a></span><span class="op">(</span><span class="va">...</span>, formula <span class="op">=</span> <span class="va">form</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We can then specify our GCKM method settings in a similar way as we did for the KmL method, but with the <code>proc</code> argument set to the <code>fitGCKM</code> function we have just defined.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gckmMethodGrid</span> <span class="op">&lt;-</span> <span class="fu">simTool</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/simTool/man/expand_tibble.html" class="external-link">expand_tibble</a></span><span class="op">(</span>
  proc <span class="op">=</span> <span class="st">"fitGCKM"</span>,
  method <span class="op">=</span> <span class="st">"lcMethodGCKM"</span>,
  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"constant"</span>, <span class="st">"linear"</span><span class="op">)</span>,
  nClusters <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,
  seed <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>
<span class="op">)</span></code></pre></div>
<p>Finally, we combine our method-specific permutation grids into one large grid. By using the <code>bind_rows()</code> function, mismatches in the columns between the grids are handled properly.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">methodGrid</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">kmlMethodGrid</span>, <span class="va">gckmMethodGrid</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">methodGrid</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 Ã— 6</span></span>
<span class="co">#&gt;   proc    method       nClusters  seed response type    </span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> latrend lcMethodKML          1     1 Y        <span style="color: #BB0000;">NA</span>      </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> latrend lcMethodKML          2     1 Y        <span style="color: #BB0000;">NA</span>      </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> latrend lcMethodKML          3     1 Y        <span style="color: #BB0000;">NA</span>      </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> fitGCKM lcMethodGCKM         1     1 <span style="color: #BB0000;">NA</span>       constant</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> fitGCKM lcMethodGCKM         1     1 <span style="color: #BB0000;">NA</span>       linear  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">6</span> fitGCKM lcMethodGCKM         2     1 <span style="color: #BB0000;">NA</span>       constant</span></code></pre></div>
</div>
</div>
<div class="section level1">
<h1 id="evaluating-the-settings">Evaluating the settings<a class="anchor" aria-label="anchor" href="#evaluating-the-settings"></a>
</h1>
<p>The <code>eval_tibbles()</code> function takes the data and method grids as inputs, and runs the method estimation as intended for each simulation setting. In practice, it is advisable to run evaluations in parallel as the number of simulation settings is likely much greater than in this trivial demonstration.</p>
<p>Before we run the simulations, we first want to define a function for computing our model performance metrics. This function will be run by <code>eval_tibbles()</code> for every estimated model. The details on what we are computing here is explained further in the next section.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">analyzeModel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model.data.html">model.data</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>
  <span class="va">refModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lcModelPartition.html">lcModelPartition</a></span><span class="op">(</span><span class="va">data</span>, response <span class="op">=</span> <span class="st">"Y"</span>, trajectoryAssignments <span class="op">=</span> <span class="st">"Class"</span><span class="op">)</span>
  
  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>
    BIC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">BIC</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>,
    APPA <span class="op">=</span> <span class="fu"><a href="../reference/metric.html">metric</a></span><span class="op">(</span><span class="va">model</span>, <span class="st">"APPA"</span><span class="op">)</span>,
    WMAE <span class="op">=</span> <span class="fu"><a href="../reference/metric.html">metric</a></span><span class="op">(</span><span class="va">model</span>, <span class="st">"WMAE"</span><span class="op">)</span>,
    ARI <span class="op">=</span> <span class="fu"><a href="../reference/externalMetric.html">externalMetric</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">refModel</span>, <span class="st">"adjustedRand"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>At last, we can run the simulations and post-hoc summary computations:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">simTool</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/simTool/man/eval_tibbles.html" class="external-link">eval_tibbles</a></span><span class="op">(</span>
  data_grid <span class="op">=</span> <span class="va">dataGrid</span>, 
  proc_grid <span class="op">=</span> <span class="va">methodGrid</span>,
  post_analyze <span class="op">=</span> <span class="va">analyzeModel</span>
<span class="op">)</span>
<span class="co">#&gt; Warning in rgl.init(initValue, onlyNULL): RGL: unable to open X11 display</span>
<span class="co">#&gt; Warning: 'rgl.init' failed, running with 'rgl.useNULL = TRUE'.</span>
<span class="co">#&gt; Warning: no DISPLAY variable so Tk is not available</span></code></pre></div>
<p>The <code>result</code> table contains a <code>results</code> column containing the fitted models.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 120 Ã— 15</span></span>
<span class="co">#&gt;    fun     numTraj randomScales data.seed replications proc    method  nClusters</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> dataGen      50          0.1         1            1 latrend lcMethâ€¦         1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> dataGen      50          0.1         1            1 latrend lcMethâ€¦         2</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> dataGen      50          0.1         1            1 latrend lcMethâ€¦         3</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> dataGen      50          0.1         1            1 fitGCKM lcMethâ€¦         1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> dataGen      50          0.1         1            1 fitGCKM lcMethâ€¦         1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> dataGen      50          0.1         1            1 fitGCKM lcMethâ€¦         2</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> dataGen      50          0.1         1            1 fitGCKM lcMethâ€¦         2</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> dataGen      50          0.1         1            1 fitGCKM lcMethâ€¦         3</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> dataGen      50          0.1         1            1 fitGCKM lcMethâ€¦         3</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span> dataGen      50          0.1         1            1 fitGCKM lcMethâ€¦         1</span>
<span class="co">#&gt; <span style="color: #949494;"># â€¦ with 110 more rows, and 7 more variables: seed &lt;dbl&gt;, response &lt;chr&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   type &lt;chr&gt;, BIC &lt;dbl&gt;, APPA &lt;dbl&gt;, WMAE &lt;dbl&gt;, ARI &lt;dbl&gt;</span></span>
<span class="co">#&gt; Number of data generating functions: 8</span>
<span class="co">#&gt; Number of analyzing procedures: 15</span>
<span class="co">#&gt; Number of replications: 1</span>
<span class="co">#&gt; Estimated replications per hour: 132</span>
<span class="co">#&gt; Start of the simulation: 2021-12-06 10:26:26</span>
<span class="co">#&gt; End of the simulation: 2021-12-06 10:26:53</span></code></pre></div>
</div>
<div class="section level1">
<h1 id="analyzing-the-results">Analyzing the results<a class="anchor" aria-label="anchor" href="#analyzing-the-results"></a>
</h1>
<p>We can now analyze the computed results. We use the <a href="https://cran.r-project.org/package=data.table" class="external-link">data.table</a> package to handle the filtering and aggregation of the results table.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span>
<span class="va">resultsTable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">simulation</span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="recovery-of-the-number-of-clusters">Recovery of the number of clusters<a class="anchor" aria-label="anchor" href="#recovery-of-the-number-of-clusters"></a>
</h2>
<p>Often, researchers are interested in estimating the number of clusters by means of minimizing a metric indicating either model fit, cluster separation, or another factor that helps to determine the preferred number of clusters. Evaluating how many times the correct number of clusters is obtained from a cluster metric can help to decide which metric to use, and which selection approach to take.</p>
<p>In this example, we evaluate the use of the Bayesian information criterion (BIC). For each data scenario, we identify the cluster solution that minimizes the BIC.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resultsTable</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>K <span class="op">=</span> <span class="va">nClusters</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="va">BIC</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">numTraj</span>, <span class="va">randomScales</span>, <span class="va">data.seed</span>, <span class="va">method</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt;     numTraj randomScales data.seed       method K</span>
<span class="co">#&gt;  1:      50          0.1         1 lcMethodGCKM 3</span>
<span class="co">#&gt;  2:      50          0.1         1  lcMethodKML 3</span>
<span class="co">#&gt;  3:      50          0.1         2 lcMethodGCKM 3</span>
<span class="co">#&gt;  4:      50          0.1         2  lcMethodKML 3</span>
<span class="co">#&gt;  5:      50          0.5         1 lcMethodGCKM 3</span>
<span class="co">#&gt;  6:      50          0.5         1  lcMethodKML 3</span>
<span class="co">#&gt;  7:      50          0.5         2 lcMethodGCKM 3</span>
<span class="co">#&gt;  8:      50          0.5         2  lcMethodKML 3</span>
<span class="co">#&gt;  9:     250          0.1         1 lcMethodGCKM 3</span>
<span class="co">#&gt; 10:     250          0.1         1  lcMethodKML 3</span>
<span class="co">#&gt; 11:     250          0.1         2 lcMethodGCKM 3</span>
<span class="co">#&gt; 12:     250          0.1         2  lcMethodKML 3</span>
<span class="co">#&gt; 13:     250          0.5         1 lcMethodGCKM 3</span>
<span class="co">#&gt; 14:     250          0.5         1  lcMethodKML 3</span>
<span class="co">#&gt; 15:     250          0.5         2 lcMethodGCKM 3</span>
<span class="co">#&gt; 16:     250          0.5         2  lcMethodKML 3</span></code></pre></div>
<p>Column <em>K</em> of the table shows the selected number of clusters for each scenario. This shows that estimating the number of clusters by minimizing the BIC results in a consistent overestimation of the number of clusters in our datasets. As an alternative to minimizing the BIC, we could consider using the elbow method instead. However, in order to conclude whether that is a feasible approach to our data would require more simulations, across a greater number of cluster.</p>
</div>
<div class="section level2">
<h2 id="trajectory-assignment-agreement">Trajectory assignment agreement<a class="anchor" aria-label="anchor" href="#trajectory-assignment-agreement"></a>
</h2>
<p>Another aspect of interest might be the ability of the cluster model to identify the correct cluster assignment for each of the trajectories. An intuitive metric for assessing this is the adjusted Rand index (ARI). This metric measures the agreement between two partitionings, where a score of 1 indicate a perfect agreement, and a score of 0 indicates an agreement no better than by chance.</p>
<p>We compute the average ARI per data scenario and method to identify in which scenarios the methods were able to recover the reference cluster assignments.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resultsTable</span><span class="op">[</span><span class="va">nClusters</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="fu">.</span><span class="op">(</span>ARI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ARI</span><span class="op">)</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">nClusters</span>, <span class="va">numTraj</span>, <span class="va">randomScales</span>, <span class="va">method</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt;     nClusters numTraj randomScales       method        ARI</span>
<span class="co">#&gt;  1:         2      50          0.1 lcMethodGCKM 1.00000000</span>
<span class="co">#&gt;  2:         2      50          0.1  lcMethodKML 1.00000000</span>
<span class="co">#&gt;  3:         2      50          0.5 lcMethodGCKM 0.47196922</span>
<span class="co">#&gt;  4:         2      50          0.5  lcMethodKML 0.13740619</span>
<span class="co">#&gt;  5:         2     250          0.1 lcMethodGCKM 0.98808217</span>
<span class="co">#&gt;  6:         2     250          0.1  lcMethodKML 1.00000000</span>
<span class="co">#&gt;  7:         2     250          0.5 lcMethodGCKM 0.45216886</span>
<span class="co">#&gt;  8:         2     250          0.5  lcMethodKML 0.13230255</span>
<span class="co">#&gt;  9:         3      50          0.1 lcMethodGCKM 0.77143848</span>
<span class="co">#&gt; 10:         3      50          0.1  lcMethodKML 0.64328345</span>
<span class="co">#&gt; 11:         3      50          0.5 lcMethodGCKM 0.39826188</span>
<span class="co">#&gt; 12:         3      50          0.5  lcMethodKML 0.04807953</span>
<span class="co">#&gt; 13:         3     250          0.1 lcMethodGCKM 0.63260781</span>
<span class="co">#&gt; 14:         3     250          0.1  lcMethodKML 0.66598327</span>
<span class="co">#&gt; 15:         3     250          0.5 lcMethodGCKM 0.31915680</span>
<span class="co">#&gt; 16:         3     250          0.5  lcMethodKML 0.10838125</span></code></pre></div>
<p>The trajectory assignment recovery is affected the most by the magnitude of the random scale (i.e., the amount of overlap between the clusters). Moreover, it is apparent that KmL performs much worse under high random scale than GCKM.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resultsTable</span><span class="op">[</span><span class="va">nClusters</span> <span class="op">&gt;</span> <span class="fl">1</span>, <span class="fu">.</span><span class="op">(</span>ARI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ARI</span><span class="op">)</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">randomScales</span>, <span class="va">nClusters</span>, <span class="va">method</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt;    randomScales nClusters       method        ARI</span>
<span class="co">#&gt; 1:          0.1         2 lcMethodGCKM 0.99404109</span>
<span class="co">#&gt; 2:          0.1         2  lcMethodKML 1.00000000</span>
<span class="co">#&gt; 3:          0.1         3 lcMethodGCKM 0.70202315</span>
<span class="co">#&gt; 4:          0.1         3  lcMethodKML 0.65463336</span>
<span class="co">#&gt; 5:          0.5         2 lcMethodGCKM 0.46206904</span>
<span class="co">#&gt; 6:          0.5         2  lcMethodKML 0.13485437</span>
<span class="co">#&gt; 7:          0.5         3 lcMethodGCKM 0.35870934</span>
<span class="co">#&gt; 8:          0.5         3  lcMethodKML 0.07823039</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="residual-error">Residual error<a class="anchor" aria-label="anchor" href="#residual-error"></a>
</h2>
<p>Another aspect of interest might be the residual error, i.e., how well our cluster model describes the data. Here, we gauge this by computing the mean absolute error, weighted by the posterior probabilities<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p>
<p>Both methods achieve practically the same mean residual error. Another sign of the data comprising two clusters is that the MAE drops down significantly for the two-cluster solution, but hardly any improvement is gained for the three-cluster solution.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resultsTable</span><span class="op">[</span><span class="va">randomScales</span> <span class="op">==</span> <span class="fl">.1</span>, <span class="fu">.</span><span class="op">(</span>WMAE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">WMAE</span><span class="op">)</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">nClusters</span>, <span class="va">method</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt;    nClusters       method       WMAE</span>
<span class="co">#&gt; 1:         1 lcMethodGCKM 0.26270832</span>
<span class="co">#&gt; 2:         1  lcMethodKML 0.26270832</span>
<span class="co">#&gt; 3:         2 lcMethodGCKM 0.11204813</span>
<span class="co">#&gt; 4:         2  lcMethodKML 0.11192675</span>
<span class="co">#&gt; 5:         3 lcMethodGCKM 0.10389798</span>
<span class="co">#&gt; 6:         3  lcMethodKML 0.09871263</span></code></pre></div>
<p>As one would expect, the residual error is strongly affected by the magnitude of the random scale.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resultsTable</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>WMAE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">WMAE</span><span class="op">)</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">randomScales</span>, <span class="va">nClusters</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt;    randomScales nClusters      WMAE</span>
<span class="co">#&gt; 1:          0.1         1 0.2627083</span>
<span class="co">#&gt; 2:          0.1         2 0.1120239</span>
<span class="co">#&gt; 3:          0.1         3 0.1028609</span>
<span class="co">#&gt; 4:          0.5         1 0.4563443</span>
<span class="co">#&gt; 5:          0.5         2 0.3312032</span>
<span class="co">#&gt; 6:          0.5         3 0.2602839</span></code></pre></div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Another reason to avoid defining formulas directly in the permutation grid is due to the way <code>data.frame</code> and tibbles handle columns containing <code>formula</code>, returning a <code>list</code> instead of the <code>formula</code> element when querying a single row. This results in an invalid method specification when <code>eval_tibbles()</code> calls the <code>proc</code> argument using this output.<a href="#fnref1" class="footnote-back">â†©ï¸Ž</a></p></li>
<li id="fn2"><p>For KmL and GCKM, the WMAE is effectively the same as the MAE.<a href="#fnref2" class="footnote-back">â†©ï¸Ž</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Niek Den Teuling.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
