---
title: "Demonstration of latrend package"
author: "Niek Den Teuling"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true # table of content true
    toc_depth : 2  
vignette: >
  %\VignetteIndexEntry{Demonstration of latrend package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(latrend)
library(ggplot2)
knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>"
)
```

```{r, results='hide',message=FALSE,warning=FALSE}
library(latrend)
library(ggplot2)
library(magrittr)
options(latrend.verbose = TRUE)
```

We will demonstrate how the exploration for the most appropriate method and model can be done in a more systematic way. This vignette is a follow-up on the demonstration vignette. As such, the data exploration step is skipped.

# Loading the data
We explore the `latrendData` dataset. This is a synthetic dataset for which the reference group of each trajectory is available, indicated by the `Class` column. However, in this vignette we will assume that the group specification and number of groups are unknown.
```{r}
data(latrendData)
head(latrendData)
```

Specify the package options to adopt the respective column names of the loaded dataset, for convenience.
```{r}
options(latrend.id = "Id", latrend.time = "Time")
```

```{r}
plotTrajectories(latrendData, response = "Y")
```

# KML clustering
```{r}
method <- lcMethodKML(response = "Y")
kmlModel <- latrend(method, latrendData)
```

```{r}
metric(kmlModel, c("logLik", "BIC", "WRSS", "WMAE"))
```
Specify KML models for a varying number of clusters.
```{r}
methods <- lcMethods(lcMethodKML(response = "Y", nRuns = 5), nClusters = 1:8)

kmlModels <- latrendBatch(methods, data = latrendData, verbose = FALSE)

kmlModels
```

# Identifying the number of clusters
```{r warning=FALSE, fig.width=10, fig.height=5, out.width='100%'}
plotMetric(kmlModels, c("logLik", "BIC", "WMAE"))
```

# Assessing the preferred model
```{r}
kmlModel4 <- subset(kmlModels, nClusters == 4, drop = TRUE)

kmlModel4
```
```{r}
plot(kmlModel4)
```

## Model adequacy
```{r}
qqPlot(kmlModel4, detrend = FALSE)
```

```{r}
qqPlot(kmlModel4, byCluster = TRUE, detrend = TRUE)
```

# Clustering using group-based trajectory modeling
```{r}
gmmRef <- lcMethodLcmmGMM(Y ~ Time * CLUSTER + (1 | Patient), idiag = TRUE, maxIter = 20, convB = 1e-2, convL = 1e-2, convG = 1e-2)
gmmMethods <- lcMethods(gmmRef, nClusters = 1:6)

gmmModels <- latrendBatch(gmmMethods, latrendData, verbose = FALSE)
```

```{r warning=FALSE, fig.width=10, fig.height=5, out.width='100%'}
plotMetric(gmmModels, c("logLik", "BIC", "WMAE"))
```

```{r}
bestGmmModel <- subset(gmmModels, nClusters == 3, drop=TRUE)
qqPlot(bestGmmModel, detrend=TRUE)
```

