---
title: "Demonstration of latrend package"
author: "Niek Den Teuling"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true # table of content true
    toc_depth : 2  
vignette: >
  %\VignetteIndexEntry{Demonstration of latrend package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(latrend)
library(ggplot2)
knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>"
)
update_geom_defaults('line', list(size = .01))
update_geom_defaults('point', list(size = .5))
```

```{r, results='hide',message=FALSE,warning=FALSE}
library(latrend)
library(ggplot2)
library(magrittr)
options(latrend.verbose=TRUE)
```

# Loading the data
```{r}
data(latrendData)
head(latrendData)
```

```{r}
options(latrend.id='Id', latrend.time='Time')
```

```{r}
plotTrajectories(latrendData, response = "Y")
```

# KML clustering
```{r}
method = lcMethodKML(response = "Y")
kmlModel = latrend(method, latrendData)
```

```{r}
metric(kmlModel, c('logLik', 'BIC', 'WRSS', 'WMAE'))
```

```{r}
methods = lcMethods(lcMethodKML(response="Y", nRuns=10), nClusters=1:9)

kmlModels = latrendBatch(methods, data = latrendData, verbose = FALSE)

kmlModels
```

# Identifying the number of clusters
```{r warning=FALSE, fig.width=10, fig.height=5, out.width='100%'}
p = plotMetric(kmlModels, c('logLik', 'BIC', 'WMAE')) +
  scale_x_continuous(breaks=seq(1, 12, by=2))
print(p)
```

# Assessing the preferred model
```{r}
kmlModel4 = subset(kmlModels, nClusters == 4, drop=TRUE)

kmlModel4
```
```{r}
plot(kmlModel4)
```

## Model adequacy
```{r}
qqPlot(kmlModel4, detrend=FALSE)
```

```{r}
qqPlot(kmlModel4, byCluster=TRUE, detrend=TRUE)
```


```{r}
bestKmlModel = subset(kmlModels, nClusters == 7, drop=TRUE)
bestKmlModel

plot(bestKmlModel)
```

```{r}
qqPlot(bestKmlModel, detrend=TRUE)
```

# Clustering using group-based trajectory modeling
```{r}
gmmRef = lcMethodLcmmGMM(Y ~ Time * CLUSTER + (1 | Patient), idiag=TRUE, maxIter=20, convB=1e-2, convL=1e-2, convG=1e-2)
gmmMethods = lcMethods(gmmRef, nClusters=1:6)

gmmModels = latrendBatch(gmmMethods, latrendData, verbose=FALSE)
```

```{r warning=FALSE, fig.width=10, fig.height=5, out.width='100%'}
p = plotMetric(gmmModels, c('logLik', 'BIC', 'WMAE')) +
  scale_x_continuous(breaks=seq(1, 12, by=2))
print(p)
```

```{r}
bestGmmModel = subset(gmmModels, nClusters == 3, drop=TRUE)
qqPlot(bestGmmModel, detrend=TRUE)
```

