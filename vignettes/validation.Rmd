---
title: "Validating cluster models"
author: "Niek Den Teuling"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true # table of content true
    toc_depth : 2  
vignette: >
  %\VignetteIndexEntry{Validating cluster models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(latrend)
library(ggplot2)
knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>"
)
options(latrend.verbose = FALSE)
```

```{r, results='hide',message=FALSE,warning=FALSE}
library(latrend)
library(ggplot2)
library(magrittr)
set.seed(1)
```

# Loading the data
We explore the `latrendData` dataset. This is a synthetic dataset for which the reference group of each trajectory is available, indicated by the `Class` column. However, in this vignette we will assume that the true group specification and number of groups are unknown. Instead, we have a candidate model which we wish to validate internally.
```{r}
data(latrendData)
head(latrendData)
```

Specify the package options to adopt the respective column names of the loaded dataset, for convenience.
```{r}
options(latrend.id = "Id", latrend.time = "Time")
```

# Candidate model
```{r}
kml <- lcMethodKML("Y", nClusters = 3, nbRedrawing = 5)
kml
```

# Evaluate stability of the estimation through repeated estimation
```{r}
repModels <- latrendRep(kml, data = latrendData, .rep=10)
print(repModels, excludeShared = FALSE)
```

```{r}
repSelfMetrics <- metric(repModels, name = c("BIC", "WMAE", "APPA"))
head(repSelfMetrics)
```

```{r}
repSelfMetrics[, "WMAE"] %>% summary()
```

```{r}
repSelfMetrics[, "APPA"] %>% summary()
```

## Comparison between fits
Select the model with the best fit, compare the other fits against this model.
```{r}
bestRepModel <- min(repModels, "BIC")
externalMetric(repModels, bestRepModel, name = "adjustedRand")
```

```{r}
distMat <- externalMetric(repModels, name = "adjustedRand")
distMat
summary(distMat)
```


# Evaluating replicability and stability through bootstrapping
```{r}
bootModels <- latrendBoot(kml, data = latrendData, samples = 10)
bootModels
```

```{r}
bootMetrics <- metric(bootModels, name = c("BIC", "WMAE", "APPA"))
bootMetrics
```


# Ten-fold cross validation
```{r}
trainModels <- latrendCV(kml, data = latrendData, folds = 10, seed = 1)
trainModels
```


## Manual cross validation
```{r}
dataFolds <- createTrainDataFolds(latrendData, folds = 10)
foldModels <- latrendBatch(kml, data = dataFolds)
foldModels
```

```{r}
testDataFolds <- createTestDataFolds(latrendData, dataFolds)
```

